<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon Dice - Pi Network</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="/static/css/simon.css" rel="stylesheet">
    <link href="/static/css/scoreboard.css" rel="stylesheet">
    <link href="/static/css/payment-counter.css" rel="stylesheet">
</head>
<body>
    <!-- Partículas de fondo -->
    <div class="particle-container" id="particles"></div>
    <div class="container">
        <div class="header-section">
            <h1>Simon Dice - Pi Network</h1>
            <div class="user-info-bar">
                <div><i class="fas fa-user"></i> Usuario: <span id="username-display"></span></div>
                <div><i class="fas fa-wallet"></i> Balance: <span id="balance-display"></span> Pi</div>
                <div><i class="fas fa-database"></i> Registros: <span id="records-display">0</span></div>
            </div>
        </div>

        <!-- MEJORA: Botón para solicitar autenticación manualmente si hay algún problema -->
        <div class="user-auth-helper" style="text-align: center; margin: 10px 0; display: none; background-color: rgba(30, 30, 70, 0.7); border-radius: 10px; padding: 15px;" id="auth-helper">
            <p style="color: #f8d7da; margin-bottom: 10px;">Si no puedes ver tu nombre de usuario, puedes intentar autenticarte manualmente:</p>
            <button id="manual-auth-button" class="btn btn-warning btn-sm">
                <i class="fas fa-user-lock"></i> Iniciar Sesión
            </button>
        </div>

        <div class="game-container">
            <div class="simon-container">
                <div class="simon-board" id="simon-board">
                    <div class="simon-button green" id="green"></div>
                    <div class="simon-button red" id="red"></div>
                    <div class="simon-button yellow" id="yellow"></div>
                    <div class="simon-button blue" id="blue"></div>
                    <div class="simon-controls">
                        <div class="controls-title">SIMON</div>
                        <div class="score-display" id="score">0</div>
                        <button class="start-button" id="start-button">INICIO</button>
                    </div>
                </div>
            </div>
            
            <div class="game-info">
                <h5><i class="fas fa-gamepad"></i> Cómo jugar</h5>
                <ol>
                    <li>Presiona el botón <strong>INICIO</strong> para comenzar</li>
                    <li>Observa la secuencia de colores que se iluminan</li>
                    <li>Repite la secuencia haciendo clic en los colores en el mismo orden</li>
                    <li>Por cada secuencia correcta, ganarás puntos</li>
                    <li>El juego se vuelve más difícil a medida que avanzas</li>
                </ol>
            </div>
            
            <div class="action-buttons">
                <button id="logout-button" class="btn btn-warning">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
                <button id="donation-button" class="btn btn-success">
                    <i class="fas fa-gamepad"></i> Jugar (0.20 Pi)
                </button>
            </div>
            
            <div id="paymentResult" style="display: none;">
                <div class="alert-info">
                    <h6><i class="fas fa-info-circle"></i> Estado del pago: <span id="paymentStatus"></span></h6>
                    <h6><i class="fas fa-receipt"></i> ID de transacción: <span id="txid"></span></h6>
                </div>
            </div>
            
            <!-- Botón de ayuda para problemas de pago -->
            <div class="mt-2" id="payment-help-container">
                <button id="force-cancel-button" class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-exclamation-triangle"></i> ¿Problemas con pagos?
                </button>
            </div>
            
            <!-- Tabla de puntuaciones -->
            <div class="scoreboard-container">
                <div id="user-best-score"></div>
                <div id="scoreboard" class="scoreboard">
                    <!-- La tabla de puntuaciones se generará aquí -->
                </div>
                <div class="scoreboard-actions mt-2">
                    <button id="reset-scores-button" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-trash-alt"></i> Reiniciar Puntuaciones Locales
                    </button>
                </div>
            </div>
            
            <!-- Contador de Pagos -->
            <div id="payment-counter" class="payment-counter">
                <h4><i class="fas fa-coins"></i> Fondo para Transferencias</h4>
                <div class="payment-counter-data">
                    <div class="counter-item">
                        <div class="label">Cantidad acumulada</div>
                        <div class="value">0.00 Pi</div>
                    </div>
                    <div class="counter-item">
                        <div class="label">Pagos recibidos</div>
                        <div class="value">0</div>
                    </div>
                    <div class="counter-item">
                        <div class="label">Última actualización</div>
                        <div class="value">--</div>
                    </div>
                </div>
                <div class="counter-note">
                    Por cada pago de 0.20 Pi, 0.10 Pi va a la wallet principal y 0.10 Pi se añade a este fondo para transferencia manual posterior.
                </div>
            </div>
        </div>
    </div>

    <!-- SDK de Pi Network -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    
    <!-- Particles Effects -->
    <script src="/static/js/particle-effects.js"></script>
    
    <!-- Sistema de Pagos Pi Network -->
    <script src="/static/js/payments.js"></script>
    <script src="/static/js/payments.checkpendingpayments.js"></script>
    
    <!-- Sistema de audio con variación de tono -->
    <script src="/static/js/audio/SoundManager.js"></script>
    
    <!-- Script actualizado para el juego Simon -->
    <script src="/static/js/simon.js"></script>
    
    <!-- Sistema de puntuaciones -->
    <script src="/static/js/scoreboard.js"></script>
    
    <!-- Sistema de contador de pagos -->
    <script src="/static/js/payment-counter.js"></script>
    
    <!-- Script adicional para asegurar que se muestre el nombre de usuario -->
    <script>
        // Ejecutar después de que todo se haya cargado
        window.addEventListener('load', function() {
            // Verificar si el nombre de usuario está vacío después de 3 segundos
            setTimeout(function() {
                var usernameDisplay = document.getElementById('username-display');
                if (usernameDisplay && (!usernameDisplay.textContent || usernameDisplay.textContent.trim() === '')) {
                    console.log('Nombre de usuario no detectado, estableciendo valor de respaldo...');
                    
                    // Intentar obtener de localStorage primero
                    try {
                        var userData = JSON.parse(localStorage.getItem('piUserData') || '{}');
                        if (userData && userData.username) {
                            usernameDisplay.textContent = userData.username;
                            console.log('Nombre establecido desde localStorage en script de respaldo');
                        } else {
                            // Si no hay datos en localStorage, establecer un valor predeterminado
                            usernameDisplay.textContent = 'Pioneer';
                            console.log('Nombre establecido como Pioneer en script de respaldo');
                        }
                    } catch (e) {
                        // En caso de error, establecer un valor predeterminado
                        usernameDisplay.textContent = 'Pioneer';
                        console.log('Error en script de respaldo, nombre establecido como Pioneer');
                    }
                }
            }, 3000); // Verificar después de 3 segundos
        });
        
        // Mostrar botón de ayuda si el usuario es "Pioneer" después de un tiempo
        setTimeout(function() {
            var usernameDisplay = document.getElementById('username-display');
            var authHelper = document.getElementById('auth-helper');
            if (usernameDisplay && (usernameDisplay.textContent === 'Pioneer' || !usernameDisplay.textContent)) {
                authHelper.style.display = 'block';
            }
        }, 4000);
        
        // Al hacer clic en el botón de autenticación manual
        document.getElementById('manual-auth-button').addEventListener('click', function() {
            if (typeof Pi !== 'undefined') {
                Pi.init({ version: "2.0", sandbox: true });
                Pi.authenticate(['payments', 'username'], {
                    onIncompletePaymentFound: function(payment) {
                        console.log('Pago incompleto encontrado:', payment);
                        if (typeof PaymentSystem !== 'undefined' && PaymentSystem.handleIncompletePayment) {
                            PaymentSystem.handleIncompletePayment(payment);
                        }
                    }
                }).then(function(auth) {
                    if (auth && auth.user && auth.user.username) {
                        var usernameDisplay = document.getElementById('username-display');
                        if (usernameDisplay) {
                            usernameDisplay.textContent = auth.user.username;
                            usernameDisplay.dataset.usernameLocked = 'true';
                            
                            // Guardar datos en localStorage
                            try {
                                var userData = JSON.parse(localStorage.getItem('piUserData') || '{}');
                                userData.username = auth.user.username;
                                userData.accessToken = auth.accessToken;
                                localStorage.setItem('piUserData', JSON.stringify(userData));
                                sessionStorage.setItem('piUserData', JSON.stringify(userData));
                                
                                // Actualizar balance si está disponible PaymentSystem
                                if (typeof PaymentSystem !== 'undefined' && PaymentSystem.setAccessToken) {
                                    PaymentSystem.setAccessToken(auth.accessToken);
                                    console.log('Token de acceso actualizado en PaymentSystem');
                                    
                                    // Intentar obtener balance
                                    if (PaymentSystem.getWalletInfo) {
                                        PaymentSystem.getWalletInfo(auth.accessToken)
                                            .then(function(walletInfo) {
                                                var balanceDisplay = document.getElementById('balance-display');
                                                if (balanceDisplay && walletInfo && walletInfo.balance) {
                                                    balanceDisplay.textContent = walletInfo.balance;
                                                    userData.balance = walletInfo.balance;
                                                    localStorage.setItem('piUserData', JSON.stringify(userData));
                                                }
                                            })
                                            .catch(function(error) {
                                                console.warn('Error al obtener información de wallet:', error);
                                            });
                                    }
                                }
                            } catch (e) {
                                console.error('Error al guardar datos:', e);
                            }
                            
                            // Ocultar ayuda
                            document.getElementById('auth-helper').style.display = 'none';
                            
                            // Mostrar mensaje de éxito
                            alert('Autenticación exitosa. Bienvenido, ' + auth.user.username + '!');
                        }
                    } else {
                        alert('Error: No se pudieron obtener los datos de usuario.');
                    }
                }).catch(function(error) {
                    console.error('Error en autenticación manual:', error);
                    alert('Error en la autenticación: ' + (error.message || 'Intenta recargar la página'));
                });
            } else {
                alert('Error: SDK de Pi no disponible. Intenta recargar la página.');
            }
        });
        
        // Funcionalidad del botón para cancelar pagos
        document.getElementById('force-cancel-button').addEventListener('click', function() {
            // Primera opción: intentar la función directamente
            try {
                if (typeof PaymentSystem !== 'undefined' && PaymentSystem.forcePaymentCancellation) {
                    PaymentSystem.forcePaymentCancellation();
                } else {
                    // Segunda opción: recargar con parámetro especial
                    window.location.href = window.location.pathname + '?force_cancel=true';
                }
            } catch (e) {
                // Tercera opción si todo falla: recargar con parámetro especial
                window.location.href = window.location.pathname + '?force_cancel=true';
            }
        });
    </script>
</body>
</html>
